<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>液相流动相计算器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 0;
        }
        
        .input-section {
            flex: 1;
            min-width: 300px;
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .result-section {
            flex: 1;
            min-width: 300px;
            padding: 25px;
            background-color: #f9fafb;
        }
        
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a73e8;
            color: #1a73e8;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .gradient-container {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        .gradient-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .gradient-table th, .gradient-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        
        .gradient-table th {
            background-color: #f1f3f4;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .gradient-table input {
            width: 80px;
            padding: 8px;
            text-align: center;
        }
        
        .btn {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background-color: #0d47a1;
        }
        
        .btn-secondary {
            background-color: #5f6368;
        }
        
        .btn-secondary:hover {
            background-color: #3c4043;
        }
        
        .btn-danger {
            background-color: #ea4335;
        }
        
        .btn-danger:hover {
            background-color: #d33426;
        }
        
        .btn-success {
            background-color: #34a853;
        }
        
        .btn-success:hover {
            background-color: #2e8b47;
        }
        
        .result-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .result-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #1a73e8;
            font-weight: 600;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .result-label {
            font-weight: 600;
            color: #555;
        }
        
        .result-value {
            font-weight: 600;
            color: #1a73e8;
        }
        
        .volumes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .volumes-table th, .volumes-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        
        .volumes-table th {
            background-color: #f1f3f4;
        }
        
        .volumes-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            background-color: #f1f3f4;
            color: #5f6368;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .phase-badge {
            display: inline-block;
            background: #1a73e8;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .input-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .gradient-table {
                font-size: 14px;
            }
            
            .gradient-table input {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>液相流动相计算器</h1>
            <p class="subtitle">根据梯度程序、流速和针数计算流动相配置量</p>
        </header>
        
        <div class="content">
            <div class="input-section">
                <h2 class="section-title">参数设置</h2>
                
                <div class="form-group">
                    <label for="flowRate">流速 (mL/min)</label>
                    <input type="number" id="flowRate" min="0.1" step="0.1" value="1.0">
                </div>
                
                <div class="form-group">
                    <label for="numInjections">针数</label>
                    <input type="number" id="numInjections" min="1" value="10">
                </div>
                
                <div class="form-group">
                    <label for="safetyFactor">安全系数</label>
                    <input type="number" id="safetyFactor" min="1.0" step="0.1" value="1.2">
                    <small style="color: #666; margin-top: 5px; display: block;">推荐1.2-1.5，提供20-50%的额外余量</small>
                </div>
                
                <div class="form-group">
                    <label for="systemVolume">系统死体积 (mL)</label>
                    <input type="number" id="systemVolume" min="0" step="0.1" value="1.0">
                </div>
                
                <div class="form-group">
                    <label for="columnVolume">柱体积 (mL)</label>
                    <input type="number" id="columnVolume" min="0" step="0.1" value="2.0">
                </div>
                
                <div class="form-group">
                    <label for="numPhases">流动相数量</label>
                    <select id="numPhases">
                        <option value="2">2相 (A, B)</option>
                        <option value="3">3相 (A, B, C)</option>
                    </select>
                </div>
                
                <h2 class="section-title">梯度程序</h2>
                <p>预设6个梯度步骤，可以根据需要修改或添加更多步骤</p>
                
                <div class="gradient-container">
                    <table class="gradient-table" id="gradientTable">
                        <thead>
                            <tr>
                                <th>步骤</th>
                                <th>时间 (min)</th>
                                <th>流动相 A (%)</th>
                                <th>流动相 B (%)</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="gradientBody">
                            <!-- 梯度行将通过JavaScript动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="button-group">
                    <button class="btn" id="addRow">添加梯度步骤</button>
                    <button class="btn btn-success" id="calculate">计算</button>
                    <button class="btn btn-secondary" id="reset">重置</button>
                </div>
            </div>
            
            <div class="result-section">
                <h2 class="section-title">计算结果</h2>
                
                <div id="resultsContainer">
                    <div class="result-box">
                        <div class="result-title">基本参数</div>
                        <div class="result-row">
                            <span class="result-label">流速:</span>
                            <span class="result-value" id="resultFlowRate">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">针数:</span>
                            <span class="result-value" id="resultInjections">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">每针运行时间:</span>
                            <span class="result-value" id="resultTime">-</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">安全系数:</span>
                            <span class="result-value" id="resultSafety">-</span>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-title">梯度程序</div>
                        <div id="gradientResult">
                            <!-- 梯度程序将在这里显示 -->
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-title">体积计算结果</div>
                        <table class="volumes-table" id="volumesTable">
                            <thead>
                                <tr>
                                    <th>流动相</th>
                                    <th>每针体积 (mL)</th>
                                    <th>总配置体积 (mL)</th>
                                </tr>
                            </thead>
                            <tbody id="volumesBody">
                                <!-- 体积结果将在这里显示 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="noResults" style="text-align: center; padding: 40px; color: #5f6368;">
                    <p>输入参数并点击"计算"按钮查看结果</p>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>液相流动相计算器 &copy; 2025 实验室工具</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const flowRateInput = document.getElementById('flowRate');
            const numInjectionsInput = document.getElementById('numInjections');
            const safetyFactorInput = document.getElementById('safetyFactor');
            const systemVolumeInput = document.getElementById('systemVolume');
            const columnVolumeInput = document.getElementById('columnVolume');
            const numPhasesSelect = document.getElementById('numPhases');
            const gradientBody = document.getElementById('gradientBody');
            const addRowButton = document.getElementById('addRow');
            const calculateButton = document.getElementById('calculate');
            const resetButton = document.getElementById('reset');
            const resultsContainer = document.getElementById('resultsContainer');
            const noResults = document.getElementById('noResults');
            
            // 初始化时隐藏结果
            resultsContainer.style.display = 'none';
            noResults.style.display = 'block';
            
            // 添加梯度步骤行
            addRowButton.addEventListener('click', function() {
                addGradientRow();
            });
            
            // 删除行事件委托
            gradientBody.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-row')) {
                    const row = e.target.closest('tr');
                    const rows = gradientBody.querySelectorAll('tr');
                    // 确保至少保留一行
                    if (rows.length > 1) {
                        row.remove();
                        updateStepNumbers();
                    } else {
                        alert('至少需要保留一个梯度步骤');
                    }
                }
            });
            
            // 计算按钮点击事件
            calculateButton.addEventListener('click', function() {
                calculateVolumes();
            });
            
            // 重置按钮点击事件
            resetButton.addEventListener('click', function() {
                resetForm();
            });
            
            // 流动相数量变化时更新表格
            numPhasesSelect.addEventListener('change', function() {
                updateGradientTable();
            });
            
            // 比例输入变化时自动调整其他相的比例（仅限两相系统）
            gradientBody.addEventListener('input', function(e) {
                if (e.target.classList.contains('ratio-input')) {
                    const numPhases = parseInt(numPhasesSelect.value);
                    if (numPhases === 2) {
                        autoAdjustRatios(e.target);
                    }
                }
            });
            
            // 自动调整两相系统的比例
            function autoAdjustRatios(changedInput) {
                const row = changedInput.closest('tr');
                const ratioInputs = row.querySelectorAll('.ratio-input');
                
                if (ratioInputs.length !== 2) return;
                
                const inputA = ratioInputs[0];
                const inputB = ratioInputs[1];
                
                // 确定哪个输入框被更改
                if (changedInput === inputA) {
                    // A相被更改，自动调整B相
                    inputB.value = 100 - parseFloat(inputA.value);
                } else {
                    // B相被更改，自动调整A相
                    inputA.value = 100 - parseFloat(inputB.value);
                }
            }
            
            // 添加梯度行函数
            function addGradientRow() {
                const numPhases = parseInt(numPhasesSelect.value);
                const row = document.createElement('tr');
                const stepNumber = gradientBody.querySelectorAll('tr').length + 1;
                
                // 步骤编号
                const stepCell = document.createElement('td');
                stepCell.textContent = stepNumber;
                row.appendChild(stepCell);
                
                // 时间输入
                const timeCell = document.createElement('td');
                const timeInput = document.createElement('input');
                timeInput.type = 'number';
                timeInput.className = 'time-input';
                timeInput.min = '0';
                timeInput.step = '0.1';
                timeInput.value = '5';
                timeCell.appendChild(timeInput);
                row.appendChild(timeCell);
                
                // 比例输入
                for (let i = 0; i < numPhases; i++) {
                    const ratioCell = document.createElement('td');
                    const ratioInput = document.createElement('input');
                    ratioInput.type = 'number';
                    ratioInput.className = 'ratio-input';
                    ratioInput.min = '0';
                    ratioInput.max = '100';
                    // 默认设置第一个相为100%，其他为0%
                    ratioInput.value = i === 0 ? '100' : '0';
                    ratioCell.appendChild(ratioInput);
                    row.appendChild(ratioCell);
                }
                
                // 删除按钮
                const actionCell = document.createElement('td');
                const removeButton = document.createElement('button');
                removeButton.className = 'btn btn-danger remove-row';
                removeButton.textContent = '删除';
                actionCell.appendChild(removeButton);
                row.appendChild(actionCell);
                
                gradientBody.appendChild(row);
            }
            
            // 更新步骤编号
            function updateStepNumbers() {
                const rows = gradientBody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
            }
            
            // 更新梯度表格
            function updateGradientTable() {
                const numPhases = parseInt(numPhasesSelect.value);
                const headerRow = document.querySelector('#gradientTable thead tr');
                
                // 更新表头
                headerRow.innerHTML = '<th>步骤</th><th>时间 (min)</th>';
                for (let i = 0; i < numPhases; i++) {
                    const phaseName = String.fromCharCode(65 + i); // A, B, C, D
                    headerRow.innerHTML += `<th>相 ${phaseName} (%)</th>`;
                }
                headerRow.innerHTML += '<th>操作</th>';
                
                // 更新表格内容 - 预设6行
                gradientBody.innerHTML = '';
                for (let i = 0; i < 6; i++) {
                    addGradientRow();
                }
            }
            
            // 计算体积函数
            function calculateVolumes() {
                // 获取输入值
                const flowRate = parseFloat(flowRateInput.value);
                const numInjections = parseInt(numInjectionsInput.value);
                const safetyFactor = parseFloat(safetyFactorInput.value);
                const systemVolume = parseFloat(systemVolumeInput.value);
                const columnVolume = parseFloat(columnVolumeInput.value);
                const numPhases = parseInt(numPhasesSelect.value);
                
                // 验证输入
                if (isNaN(flowRate) || flowRate <= 0) {
                    alert('请输入有效的流速');
                    return;
                }
                
                if (isNaN(numInjections) || numInjections <= 0) {
                    alert('请输入有效的针数');
                    return;
                }
                
                // 获取梯度程序
                const gradientProgram = [];
                const rows = gradientBody.querySelectorAll('tr');
                
                for (const row of rows) {
                    const timeInput = row.querySelector('.time-input');
                    const ratioInputs = row.querySelectorAll('.ratio-input');
                    
                    const time = parseFloat(timeInput.value);
                    if (isNaN(time) || time <= 0) {
                        alert('请输入有效的时间值');
                        return;
                    }
                    
                    const ratios = [];
                    let totalRatio = 0;
                    
                    for (const input of ratioInputs) {
                        const ratio = parseFloat(input.value);
                        if (isNaN(ratio) || ratio < 0) {
                            alert('请输入有效的比例值');
                            return;
                        }
                        ratios.push(ratio);
                        totalRatio += ratio;
                    }
                    
                    // 检查比例总和是否为100%
                    if (Math.abs(totalRatio - 100) > 0.1) {
                        alert(`步骤 ${row.cells[0].textContent} 的比例总和为 ${totalRatio.toFixed(1)}%，不是100%。请调整比例值。`);
                        return;
                    }
                    
                    gradientProgram.push({
                        time: time,
                        ratios: ratios
                    });
                }
                
                if (gradientProgram.length === 0) {
                    alert('请至少添加一个梯度步骤');
                    return;
                }
                
                // 计算每针各流动相体积
                // 根据用户要求，每针运行时间是最后一个梯度步骤的时间
                const totalTime = gradientProgram[gradientProgram.length - 1].time;
                const volumesPerInjection = new Array(numPhases).fill(0);
                
                // 计算最后一个梯度步骤中各流动相的体积
                const lastStep = gradientProgram[gradientProgram.length - 1];
                for (let i = 0; i < numPhases; i++) {
                    volumesPerInjection[i] = totalTime * flowRate * lastStep.ratios[i] / 100;
                }
                
                // 加上系统死体积和柱体积的冲洗体积
                const washVolume = systemVolume + columnVolume;
                for (let i = 0; i < numPhases; i++) {
                    volumesPerInjection[i] += washVolume / numPhases;
                }
                
                // 计算总体积 (考虑针数和安全系数)
                const totalVolumes = volumesPerInjection.map(vol => vol * numInjections * safetyFactor);
                
                // 显示结果
                displayResults(
                    flowRate, 
                    numInjections, 
                    totalTime, 
                    safetyFactor,
                    gradientProgram,
                    volumesPerInjection,
                    totalVolumes
                );
            }
            
            // 显示结果函数
            function displayResults(flowRate, numInjections, totalTime, safetyFactor, gradientProgram, volumesPerInjection, totalVolumes) {
                // 显示结果容器，隐藏提示
                resultsContainer.style.display = 'block';
                noResults.style.display = 'none';
                
                // 更新基本参数
                document.getElementById('resultFlowRate').textContent = `${flowRate} mL/min`;
                document.getElementById('resultInjections').textContent = numInjections;
                document.getElementById('resultTime').textContent = `${totalTime.toFixed(1)} 分钟`;
                document.getElementById('resultSafety').textContent = safetyFactor;
                
                // 更新梯度程序显示
                const gradientResult = document.getElementById('gradientResult');
                let gradientHtml = '<div style="overflow-x: auto;"><table class="gradient-table"><thead><tr><th>步骤</th><th>时间 (min)</th>';
                
                for (let i = 0; i < volumesPerInjection.length; i++) {
                    const phaseName = String.fromCharCode(65 + i);
                    gradientHtml += `<th>相 ${phaseName} (%)</th>`;
                }
                gradientHtml += '</tr></thead><tbody>';
                
                gradientProgram.forEach((step, index) => {
                    gradientHtml += `<tr><td>${index + 1}</td><td>${step.time}</td>`;
                    for (const ratio of step.ratios) {
                        gradientHtml += `<td>${ratio}%</td>`;
                    }
                    gradientHtml += '</tr>';
                });
                
                gradientHtml += '</tbody></table></div>';
                gradientResult.innerHTML = gradientHtml;
                
                // 更新体积结果
                const volumesBody = document.getElementById('volumesBody');
                volumesBody.innerHTML = '';
                
                for (let i = 0; i < volumesPerInjection.length; i++) {
                    const phaseName = String.fromCharCode(65 + i);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="phase-badge">相 ${phaseName}</span></td>
                        <td>${volumesPerInjection[i].toFixed(1)}</td>
                        <td>${totalVolumes[i].toFixed(1)}</td>
                    `;
                    volumesBody.appendChild(row);
                }
            }
            
            // 重置表单函数
            function resetForm() {
                flowRateInput.value = '1.0';
                numInjectionsInput.value = '10';
                safetyFactorInput.value = '1.2';
                systemVolumeInput.value = '1.0';
                columnVolumeInput.value = '2.0';
                numPhasesSelect.value = '2';
                
                // 重置梯度表格
                updateGradientTable();
                
                // 隐藏结果
                resultsContainer.style.display = 'none';
                noResults.style.display = 'block';
            }
            
            // 初始化表格
            updateGradientTable();
        });
    </script>
</body>
</html>
